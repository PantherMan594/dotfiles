#!/bin/bash

FLAGS="-avP --delete --exclude='- .ccls-cache/'"

re='^[1-8]$'
if ! [[ $1 =~ $re ]]; then
	echo "Please enter a valid number from 1-8."
	exit 1
fi

if [[ -f ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid ]]; then
	ssh_pid=$(tail -n 1 ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid)
	ssh_num=$(head -n 1 ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid)

	if kill -0 $ssh_pid; then
		echo "An SSH connection is active. This script cannot handle multiple connections. If you would still like to connect, please do so manually."
		exit 1
	fi

	if [ $ssh_num != "all" ]; then
		echo "Last SSH connection was not closed cleanly. Downloading shared folder..."
		echo $FLAGS | xargs rsync shendc@cscigpu0${ssh_num}.bc.edu:~/shared/ ~/Documents/Parallel\ Computing\ \(CSCI3396\)/shared
	fi
fi

echo "Uploading shared folder..."
echo $FLAGS | xargs rsync ~/Documents/Parallel\ Computing\ \(CSCI3396\)/shared/ shendc@cscigpu0$1.bc.edu:~/shared

echo $1 > ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid
sh -c "echo $$ >> ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid; ssh -Y shendc@cscigpu0$1.bc.edu"

echo "Downloading shared folder..."
echo $FLAGS | xargs rsync shendc@cscigpu0$1.bc.edu:~/shared/ ~/Documents/Parallel\ Computing\ \(CSCI3396\)/shared
rm ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid
