#!/bin/bash

FLAGS="-avP --delete --exclude='.ccls-cache/'"

if [[ -f ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid ]]; then
	ssh_pid=$(tail -n 1 ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid)
	ssh_num=$(head -n 1 ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid)

	if kill -0 $ssh_pid; then
		echo "An SSH connection is active. This script cannot run with an active SSH session as I cannot guarantee the correctness of the files."
		exit 1
	fi

	if [ $ssh_num != "all" ]; then
		echo "Last SSH connection was not closed cleanly. Downloading shared folder..."
		echo $FLAGS | xargs rsync cscigpu0${ssh_num}.bc.edu:~/shared/ ~/shared
	fi
fi

echo "all" > ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid
echo $$ >> ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid

for i in {1..8}; do
	echo "Uploading shared folder to cscigpu0$i..."
	echo $FLAGS | xargs rsync ~/Documents/Parallel\ Computing\ \(CSCI3396\)/shared/ shendc@cscigpu0$i.bc.edu:~/shared
done

rm ~/Documents/Parallel\ Computing\ \(CSCI3396\)/.ssh_pid
